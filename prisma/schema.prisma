generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum DeliveryStatus {
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CLIENT_VERIFIED
  MANAGER_CONFIRMED
}

enum Role {
  CLIENT
  MANAGER
  ADMIN
  DELIVERY_AGENT
}

enum OrderStatus {
  PENDING_QUOTE
  AWAITING_CLIENT_APPROVAL
  AWAITING_PAYMENT
  PAID_AND_APPROVED
  IN_TRANSIT
  DELIVERED
  CANCELED
  REJECTED
}

enum PaymentMethod {
  MTN_MOMO
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  CONFIRMED
}

enum QuoteStatus {
  PENDING_ITEMS
  PENDING_PRICING
  AWAITING_CLIENT_APPROVAL
  APPROVED
  REJECTED
  CONVERTED_TO_ORDER
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String
  email         String    @unique
  role          Role      @default(CLIENT)
  phone         String?
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  firebaseUid   String?  @unique 
  avatar        String?

  emailVerified Boolean   @default(false)

  addresses           Address[]
  orders              Order[]               @relation("ClientOrders")
  managedOrders       Order[]               @relation("ManagerOrders")
  approvedPayments    Payment[]             @relation("ManagerApprovedPayments")
  quotes              Quote[]               @relation("ManagerQuotes")
  clientQuotes        Quote[]               @relation("ClientQuotes")
  deliveries          Delivery[]            @relation("DeliveryAgent")
}

model Address {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String    @db.ObjectId
  label         String?
  line1         String
  line2         String?
  city          String
  state         String?
  postalCode    String?
  country       String
  latitude      Float?
  longitude     Float?
  isDefault     Boolean   @default(false)
  orders        Order[]
}

model Product {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  name          String
  sku           String      @unique
  description   String?
  category      String?
  price         Float
  active        Boolean     @default(true)
  orderItems    OrderItem[]
  quoteItems    QuoteItem[]
}

model Order {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  client        User        @relation("ClientOrders", fields: [clientId], references: [id])
  clientId      String      @db.ObjectId
  manager       User?       @relation("ManagerOrders", fields: [managerId], references: [id])
  managerId     String?     @db.ObjectId
  address       Address     @relation(fields: [addressId], references: [id])
  addressId     String      @db.ObjectId
  status        OrderStatus @default(PENDING_QUOTE)
  total         Float       @default(0)
  notes         String?
  items         OrderItem[]
  payment       Payment?
  quote         Quote?      @relation("OrderQuote", fields: [quoteId], references: [id])
  quoteId       String?     @unique @db.ObjectId
  delivery      Delivery?
}

model OrderItem {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       String    @db.ObjectId
  product       Product   @relation(fields: [productId], references: [id])
  productId     String    @db.ObjectId
  quantity      Int
  unitPrice     Float
  subtotal      Float
}

model Quote {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  client        User        @relation("ClientQuotes", fields: [clientId], references: [id])
  clientId      String      @db.ObjectId
  manager       User?       @relation("ManagerQuotes", fields: [managerId], references: [id])
  managerId     String?     @db.ObjectId
  status        QuoteStatus @default(PENDING_ITEMS)
  totalAmount   Float       @default(0)
  sourcingNotes String?
  validUntil    DateTime?
  items         QuoteItem[]
  order         Order?      @relation("OrderQuote")
}

model QuoteItem {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  quote         Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId       String    @db.ObjectId
  product       Product   @relation(fields: [productId], references: [id])
  productId     String    @db.ObjectId
  quantity      Int
  unitPrice     Float
  subtotal      Float
}

model Payment {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String        @unique @db.ObjectId
  amount          Float
  method          PaymentMethod @default(MTN_MOMO)
  status          PaymentStatus @default(PENDING)
  transactionRef  String?
  providerResponse Json?
  phoneNumber     String?
  approvedBy      User?         @relation("ManagerApprovedPayments", fields: [approvedById], references: [id])
  approvedById    String?       @db.ObjectId
}

model Delivery {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId            String    @unique @db.ObjectId
  agent              User      @relation("DeliveryAgent", fields: [agentId], references: [id])
  agentId            String    @db.ObjectId
  status             DeliveryStatus @default(ASSIGNED)
  currentLat         Float?
  currentLng         Float?
  estimatedDelivery  DateTime?
  actualDelivery     DateTime?
  deliveryNotes      String?
  deliveryCode       String?
  codeGeneratedAt    DateTime?
  clientVerifiedAt   DateTime?
  clientVerifiedBy   String?
  managerConfirmedAt DateTime?
  managerConfirmedBy String?
}