generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum DeliveryStatus {
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CLIENT_VERIFIED
  MANAGER_CONFIRMED
}

enum ProductWishStatus {
  PENDING           // Client submitted, waiting for admin review
  UNDER_REVIEW      // Admin is reviewing
  APPROVED          // Admin confirmed product can be sourced
  REJECTED          // Admin rejected the request
  IN_DISCUSSION     // Client and admin discussing via WhatsApp
  PRODUCT_CREATED   // Admin created the product (booked)
  QUOTE_SUBMITTED   // Client submitted quote for this product
  COMPLETED         // Entire process completed
  CANCELLED         // Client cancelled the request
}

enum Role {
  CLIENT
  MANAGER
  ADMIN
  DELIVERY_AGENT
}

enum OrderStatus {
  PENDING_QUOTE
  AWAITING_CLIENT_APPROVAL
  AWAITING_PAYMENT
  PAID_AND_APPROVED
  IN_TRANSIT
  DELIVERED
  CANCELED
  REJECTED
}

enum PaymentMethod {
  MTN_MOMO
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  CONFIRMED
}

enum QuoteStatus {
  PENDING_ITEMS
  PENDING_PRICING
  IN_PRICING
  AWAITING_CLIENT_APPROVAL
  APPROVED
  REJECTED
  CONVERTED_TO_ORDER
}

model User {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  name          String
  email         String         @unique
  password      String?
  role          Role           @default(CLIENT)
  phone         String?
  isActive      Boolean        @default(true)
  isVerified    Boolean        @default(false)
  firebaseUid   String?
  avatar        String?
  emailVerified Boolean        @default(false)
  notifications Notification[]
  activities    Activity[]
  productWishes    ProductWish[]

  addresses        Address[]
  orders           Order[]    @relation("ClientOrders")
  managedOrders    Order[]    @relation("ManagerOrders")
  approvedPayments Payment[]  @relation("ManagerApprovedPayments")
  quotes           Quote[]    @relation("ManagerQuotes")
  clientQuotes     Quote[]    @relation("ClientQuotes")
  deliveries       Delivery[] @relation("DeliveryAgent")
  lockedQuotes     Quote[]    @relation("LockedQuotes")
}

model Address {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  label      String?
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String
  latitude   Float?
  longitude  Float?
  isDefault  Boolean  @default(false)
  orders     Order[]
}

// In schema.prisma - KEEP image field temporarily
model Product {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String   @unique
  sku         String   @unique
  reference   String?
  description String?
  category    String?
  price       Float
  icon        String?
  
  // Keep image field for backward compatibility
  image       String?
  
  // Add new images array field
  images      String[] @db.String
  
  active      Boolean

  bookedForWish    ProductWish?
  isBookedProduct  Boolean @default(false)
  bookedForClientId String?

  orderItems OrderItem[]
  quoteItems QuoteItem[]

  @@map("Product")
}
model ProductWish {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  clientId        String   @db.ObjectId
  client          User     @relation(fields: [clientId], references: [id])
  
  // Product request details
  imageUrl        String?
  description     String?
  estimatedPrice  Float?
  quantity        Int      @default(1)
  
  // Status tracking
  status          ProductWishStatus @default(PENDING)
  adminResponse   String?
  adminNotes      String?
  
  // If approved and product created
  productId       String?  @unique @db.ObjectId
  product         Product? @relation(fields: [productId], references: [id])
  
  // WhatsApp conversation
  whatsappChatUrl   String?
  conversationNotes String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reviewedAt      DateTime?
  approvedAt      DateTime?
  
  @@index([clientId])
  @@index([status])
}


model Order {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  client    User        @relation("ClientOrders", fields: [clientId], references: [id])
  clientId  String      @db.ObjectId
  manager   User?       @relation("ManagerOrders", fields: [managerId], references: [id])
  managerId String?     @db.ObjectId
  address   Address     @relation(fields: [addressId], references: [id])
  addressId String      @db.ObjectId
  status    OrderStatus @default(PENDING_QUOTE)
  total     Float       @default(0)
  notes     String?
  items     OrderItem[]
  payment   Payment?
  quote     Quote?      @relation("OrderQuote", fields: [quoteId], references: [id])
  quoteId   String?     @unique @db.ObjectId
  delivery  Delivery?
}

model OrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId   String   @db.ObjectId
  product   Product  @relation(fields: [productId], references: [id])
  productId String   @db.ObjectId
  quantity  Int
  unitPrice Float
  subtotal  Float
}

model Quote {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  client        User        @relation("ClientQuotes", fields: [clientId], references: [id])
  clientId      String      @db.ObjectId
  manager       User?       @relation("ManagerQuotes", fields: [managerId], references: [id])
  managerId     String?     @db.ObjectId
  status        QuoteStatus @default(PENDING_ITEMS)
  totalAmount   Float       @default(0)
  sourcingNotes String?
  validUntil    DateTime?

  // Locking mechanism fields
  lockedById    String?   @db.ObjectId // Which manager is currently working on it
  lockedAt      DateTime?
  lockExpiresAt DateTime?

  // Update this line with relation name
  lockedBy User? @relation("LockedQuotes", fields: [lockedById], references: [id])

  items QuoteItem[]
  order Order?      @relation("OrderQuote")

  @@index([status])
  @@index([lockedById])
}

model QuoteItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId   String   @db.ObjectId
  product   Product? @relation(fields: [productId], references: [id])
  productId String?  @db.ObjectId
  quantity  Int
  unitPrice Float
  subtotal  Float

  @@index([quoteId])
  @@index([productId])
}

model Payment {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  order            Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId          String        @unique @db.ObjectId
  amount           Float
  method           PaymentMethod @default(MTN_MOMO)
  status           PaymentStatus @default(PENDING)
  transactionRef   String?
  providerResponse Json?
  phoneNumber      String?
  approvedBy       User?         @relation("ManagerApprovedPayments", fields: [approvedById], references: [id])
  approvedById     String?       @db.ObjectId
}

model Delivery {
  id                 String         @id @default(auto()) @map("_id") @db.ObjectId
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  order              Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId            String         @unique @db.ObjectId
  agent              User           @relation("DeliveryAgent", fields: [agentId], references: [id])
  agentId            String         @db.ObjectId
  status             DeliveryStatus @default(ASSIGNED)
  currentLat         Float?
  currentLng         Float?
  estimatedDelivery  DateTime?
  actualDelivery     DateTime?
  deliveryNotes      String?
  deliveryCode       String?
  codeGeneratedAt    DateTime?
  clientVerifiedAt   DateTime?
  clientVerifiedBy   String?
  managerConfirmedAt DateTime?
  managerConfirmedBy String?
}

model Notification {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  userId    String    @db.ObjectId
  title     String
  message   String
  type      String    @default("INFO") // INFO, QUOTE, DELIVERY, PAYMENT, SYSTEM
  link      String?
  read      Boolean   @default(false)
  readAt    DateTime?

  @@index([userId, read])
  @@index([createdAt])
}

model Activity {
  id          String   @id @default(cuid()) @map("_id")
  type        String // 'quote', 'order', 'user', 'system', 'payment', 'delivery'
  description String
  userId      String?
  metadata    Json?
  timestamp   DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([type])
  @@index([userId])
  @@map("activities")
}
